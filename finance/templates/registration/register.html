{% extends 'base.html' %}

{% block title %} Регистрация {% endblock %}

{% block style %}
    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
    }

    .alert-danger {
        color: #a94442;
        background-color: #f2dede;
        border-color: #ebccd1;
    }

    .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 80%;
        color: #dc3545;
    }

    .was-validated .form-control:invalid,
    .was-validated .form-control:invalid:focus {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .was-validated .form-control:valid,
    .was-validated .form-control:valid:focus {
        border-color: #28a745;
        padding-right: calc(1.5em + 0.75rem);
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
{% endblock %}

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

{% block content %}

{% if form.errors %}
  <div class="mt-5 alert alert-danger">
    <ul>
      {% for field in form %}
        {% for error in field.errors %}
          <li>{{ error }}</li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
{% endif %}

<div class="py-5">
    <div class="col-md-7 col-lg-8">
      <h4 class="mb-3">Регистрация</h4>
      <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-12">
            <label for="{{ form.username.id_for_label }}" class="form-label">Имя пользователя</label>
            <div class="input-group has-validation">
              <span class="input-group-text">@</span>
              <input type="text" class="form-control" id="{{ form.username.id_for_label }}" name="{{ form.username.name }}" placeholder="Username" required minlength="3" maxlength="150" value="{{ form.username.value|default_if_none:'' }}">
              <div class="invalid-feedback">
              </div>
            </div>
          </div>

          <div class="col-12">
            <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
            <input type="email" class="form-control" id="{{ form.email.id_for_label }}" name="{{ form.email.name }}" placeholder="you@example.com" required value="{{ form.email.value|default_if_none:'' }}">
            <div class="invalid-feedback">
            </div>
          </div>

          <div class="col-12">
            <label for="{{ form.password1.id_for_label }}" class="form-label">Пароль</label>
            <input type="password" class="form-control" id="{{ form.password1.id_for_label }}" name="{{ form.password1.name }}" required minlength="8">
            <div class="invalid-feedback">
            </div>
          </div>

          <div class="col-12">
            <label for="{{ form.password2.id_for_label }}" class="form-label">Подтверждение пароля</label>
            <input type="password" class="form-control" id="{{ form.password2.id_for_label }}" name="{{ form.password2.name }}" required>
            <div class="invalid-feedback">
            </div>
          </div>

          <hr class="my-4">

          <button class="w-100 btn btn-primary btn-lg" type="submit">Регистрация</button>
        </div>
      </form>
    </div>
  </div>

{% endblock content %}
{% block extra_js %}
<script>
(function () {
    'use strict';

    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.querySelectorAll('.needs-validation');

    // Loop over them and prevent submission
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }

            // Проверка совпадения паролей
            var password1 = form.querySelector('input[name="{{ form.password1.name }}"]').value;
            var password2 = form.querySelector('input[name="{{ form.password2.name }}"]').value;
            var password2Field = form.querySelector('input[name="{{ form.password2.name }}"]');
            var password2Feedback = form.querySelector('input[name="{{ form.password2.name }}"] + .invalid-feedback');

            if (password1 !== password2) {
                password2Feedback.textContent = "Пароли не совпадают";
                password2Feedback.style.display = "block";
                password2Field.value = ""; // Очистка поля password2
                event.preventDefault();
                event.stopPropagation();
            } else {
                password2Feedback.textContent = "";
                password2Feedback.style.display = "none";
            }

            // Проверка поля логина
            var usernameField = form.querySelector('input[name="{{ form.username.name }}"]');
            var usernameFeedback = form.querySelector('input[name="{{ form.username.name }}"] + .invalid-feedback');
            if (usernameField.value.length < 3 || usernameField.value.length > 150) {
                usernameFeedback.textContent = "Имя пользователя должно быть от 3 до 150 символов и может содержать только латинские буквы, цифры, и знаки @/./+/-/_";
                usernameFeedback.style.display = "block";
                event.preventDefault();
                event.stopPropagation();
            } else {
                usernameFeedback.textContent = "";
                usernameFeedback.style.display = "none";
            }

            // Проверка поля email
            var emailField = form.querySelector('input[name="{{ form.email.name }}"]');
            var emailFeedback = form.querySelector('input[name="{{ form.email.name }}"] + .invalid-feedback');
            var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(emailField.value)) {
                emailFeedback.textContent = "Введите корректный адрес электронной почты";
                emailFeedback.style.display = "block";
                event.preventDefault();
                event.stopPropagation();
            } else {
                emailFeedback.textContent = "";
                emailFeedback.style.display = "none";
            }

            form.classList.add('was-validated');
        }, false);
    });
})();
</script>
{% endblock extra_js %}
